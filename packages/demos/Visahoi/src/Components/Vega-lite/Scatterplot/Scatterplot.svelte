<script lang="ts">
  import embed from 'vega-embed';    
  import { generateBasicAnnotations, ahoi, EVisualizationType } from '@visahoi/vega';
  import { onMount, onDestroy } from "svelte";
  import type { IAhoiConfig } from '@visahoi/core';
    
    export let contextKey: string = 'scatterplot';
    let onboardingUI;
    let runtimeObject: object;   
    
    const getAhoiConfig = async (): Promise<IAhoiConfig> => {           
        const defaultOnboardingMessages =  await generateBasicAnnotations(
          contextKey,
          EVisualizationType.SCATTERPLOT,
          runtimeObject
        );    
        const ahoiConfig = {
          onboardingMessages: defaultOnboardingMessages,
        };
    
        return ahoiConfig;
    };   
    
    onMount(async () => {       
      const chartDom = document.getElementById('scatterplot');        
      runtimeObject = await embed(chartDom, {
        "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
        "params": [
            {
              "name": "brush",
              "select": "interval",
              "value": { "x": [55, 160], "y": [13, 37] }
            }
          ],
          "usermeta": { "embedOptions": { "renderer": "svg" } },
          "title": "Horsepower and miles per gallon for various cars",
          "mark": {"type": "circle", "tooltip": true},
          "width": "container",
          "height": "container",
          "encoding": {
            "x": { "field": "Horsepower", "type": "quantitative" },
            "y": { "field": "Miles_per_Gallon", "type": "quantitative" },
            "color": {
              "condition": { "param": "brush", "field": "Cylinders", "type": "ordinal" },
              "value": "grey"
            }
          },
        "data": {
            "values": 
            [
                {
                  "Name": "chevrolet chevelle malibu",
                  "Miles_per_Gallon": 18,
                  "Cylinders": 8,
                  "Displacement": 307,
                  "Horsepower": 130,
                  "Weight_in_lbs": 3504,
                  "Acceleration": 12,
                  "Year": "1970-01-01",
                  "Origin": "USA"
                },
                {
                  "Name": "buick skylark 320",
                  "Miles_per_Gallon": 15,
                  "Cylinders": 8,
                  "Displacement": 350,
                  "Horsepower": 165,
                  "Weight_in_lbs": 3693,
                  "Acceleration": 11.5,
                  "Year": "1970-01-01",
                  "Origin": "USA"
                },
                {
                  "Name": "plymouth satellite",
                  "Miles_per_Gallon": 18,
                  "Cylinders": 8,
                  "Displacement": 318,
                  "Horsepower": 150,
                  "Weight_in_lbs": 3436,
                  "Acceleration": 11,
                  "Year": "1970-01-01",
                  "Origin": "USA"
                },
                {
                  "Name": "amc rebel sst",
                  "Miles_per_Gallon": 16,
                  "Cylinders": 8,
                  "Displacement": 304,
                  "Horsepower": 150,
                  "Weight_in_lbs": 3433,
                  "Acceleration": 12,
                  "Year": "1970-01-01",
                  "Origin": "USA"
                },
                {
                  "Name": "ford torino",
                  "Miles_per_Gallon": 17,
                  "Cylinders": 8,
                  "Displacement": 302,
                  "Horsepower": 140,
                  "Weight_in_lbs": 3449,
                  "Acceleration": 10.5,
                  "Year": "1970-01-01",
                  "Origin": "USA"
                },
                {
                  "Name": "ford galaxie 500",
                  "Miles_per_Gallon": 15,
                  "Cylinders": 8,
                  "Displacement": 429,
                  "Horsepower": 198,
                  "Weight_in_lbs": 4341,
                  "Acceleration": 10,
                  "Year": "1970-01-01",
                  "Origin": "USA"
                },
                {
                  "Name": "chevrolet impala",
                  "Miles_per_Gallon": 14,
                  "Cylinders": 8,
                  "Displacement": 454,
                  "Horsepower": 220,
                  "Weight_in_lbs": 4354,
                  "Acceleration": 9,
                  "Year": "1970-01-01",
                  "Origin": "USA"
                },
                {
                  "Name": "plymouth fury iii",
                  "Miles_per_Gallon": 14,
                  "Cylinders": 8,
                  "Displacement": 440,
                  "Horsepower": 215,
                  "Weight_in_lbs": 4312,
                  "Acceleration": 8.5,
                  "Year": "1970-01-01",
                  "Origin": "USA"
                },
                {
                  "Name": "pontiac catalina",
                  "Miles_per_Gallon": 14,
                  "Cylinders": 8,
                  "Displacement": 455,
                  "Horsepower": 225,
                  "Weight_in_lbs": 4425,
                  "Acceleration": 10,
                  "Year": "1970-01-01",
                  "Origin": "USA"
                },
                {
                  "Name": "amc ambassador dpl",
                  "Miles_per_Gallon": 15,
                  "Cylinders": 8,
                  "Displacement": 390,
                  "Horsepower": 190,
                  "Weight_in_lbs": 3850,
                  "Acceleration": 8.5,
                  "Year": "1970-01-01",
                  "Origin": "USA"
                },
                {
                  "Name": "citroen ds-21 pallas",
                  "Miles_per_Gallon": null,
                  "Cylinders": 4,
                  "Displacement": 133,
                  "Horsepower": 115,
                  "Weight_in_lbs": 3090,
                  "Acceleration": 17.5,
                  "Year": "1970-01-01",
                  "Origin": "Europe"
                },
                {
                  "Name": "chevrolet chevelle concours (sw)",
                  "Miles_per_Gallon": null,
                  "Cylinders": 8,
                  "Displacement": 350,
                  "Horsepower": 165,
                  "Weight_in_lbs": 4142,
                  "Acceleration": 11.5,
                  "Year": "1970-01-01",
                  "Origin": "USA"
                },
                {
                  "Name": "ford torino (sw)",
                  "Miles_per_Gallon": null,
                  "Cylinders": 8,
                  "Displacement": 351,
                  "Horsepower": 153,
                  "Weight_in_lbs": 4034,
                  "Acceleration": 11,
                  "Year": "1970-01-01",
                  "Origin": "USA"
                },
                {
                  "Name": "plymouth satellite (sw)",
                  "Miles_per_Gallon": null,
                  "Cylinders": 8,
                  "Displacement": 383,
                  "Horsepower": 175,
                  "Weight_in_lbs": 4166,
                  "Acceleration": 10.5,
                  "Year": "1970-01-01",
                  "Origin": "USA"
                },
                {
                  "Name": "amc rebel sst (sw)",
                  "Miles_per_Gallon": null,
                  "Cylinders": 8,
                  "Displacement": 360,
                  "Horsepower": 175,
                  "Weight_in_lbs": 3850,
                  "Acceleration": 11,
                  "Year": "1970-01-01",
                  "Origin": "USA"
                },
                {
                  "Name": "dodge challenger se",
                  "Miles_per_Gallon": 15,
                  "Cylinders": 8,
                  "Displacement": 383,
                  "Horsepower": 170,
                  "Weight_in_lbs": 3563,
                  "Acceleration": 10,
                  "Year": "1970-01-01",
                  "Origin": "USA"
                },
                {
                  "Name": "plymouth 'cuda 340",
                  "Miles_per_Gallon": 14,
                  "Cylinders": 8,
                  "Displacement": 340,
                  "Horsepower": 160,
                  "Weight_in_lbs": 3609,
                  "Acceleration": 8,
                  "Year": "1970-01-01",
                  "Origin": "USA"
                },
                {
                  "Name": "ford mustang boss 302",
                  "Miles_per_Gallon": null,
                  "Cylinders": 8,
                  "Displacement": 302,
                  "Horsepower": 140,
                  "Weight_in_lbs": 3353,
                  "Acceleration": 8,
                  "Year": "1970-01-01",
                  "Origin": "USA"
                },
                {
                  "Name": "chevrolet monte carlo",
                  "Miles_per_Gallon": 15,
                  "Cylinders": 8,
                  "Displacement": 400,
                  "Horsepower": 150,
                  "Weight_in_lbs": 3761,
                  "Acceleration": 9.5,
                  "Year": "1970-01-01",
                  "Origin": "USA"
                },
                {
                  "Name": "buick estate wagon (sw)",
                  "Miles_per_Gallon": 14,
                  "Cylinders": 8,
                  "Displacement": 455,
                  "Horsepower": 225,
                  "Weight_in_lbs": 3086,
                  "Acceleration": 10,
                  "Year": "1970-01-01",
                  "Origin": "USA"
                },
                {
                  "Name": "toyota corona mark ii",
                  "Miles_per_Gallon": 24,
                  "Cylinders": 4,
                  "Displacement": 113,
                  "Horsepower": 95,
                  "Weight_in_lbs": 2372,
                  "Acceleration": 15,
                  "Year": "1970-01-01",
                  "Origin": "Japan"
                },
                {
                  "Name": "plymouth duster",
                  "Miles_per_Gallon": 22,
                  "Cylinders": 6,
                  "Displacement": 198,
                  "Horsepower": 95,
                  "Weight_in_lbs": 2833,
                  "Acceleration": 15.5,
                  "Year": "1970-01-01",
                  "Origin": "USA"
                },
                {
                  "Name": "amc hornet",
                  "Miles_per_Gallon": 18,
                  "Cylinders": 6,
                  "Displacement": 199,
                  "Horsepower": 97,
                  "Weight_in_lbs": 2774,
                  "Acceleration": 15.5,
                  "Year": "1970-01-01",
                  "Origin": "USA"
                },          
            
          ]
        }    
      },
    {    
        actions: false,
        renderer: 'svg'
    });

    
    if(onboardingUI) {
      onboardingUI.showOnboarding();    
      } else {      
        onboardingUI = await ahoi(
          contextKey,
          EVisualizationType.SCATTERPLOT,
          runtimeObject,
          await getAhoiConfig()
        );
      }
    });
      
    onDestroy(() => {
      if(onboardingUI) {
        onboardingUI.removeOnboarding();
      }
    });
    
    
    </script>
    <div id="vega-lite" style="width: 100%; height: 100%;">             
      <div id="scatterplot" style="width: 500px; height: 500px;"> </div>
    </div>    
    
    <style>
      :global(*) {
        font-family: sans-serif;
      }
    </style>
    